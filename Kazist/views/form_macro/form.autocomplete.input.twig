{% macro input(name, type, default, label, class, id, attributes, readonly, options, setting, context) %}

    {% import "form.macro.twig" as forms %}

    {{ set_assets('assets/js/kazist/autocomplete.js') }}

    {% set web_is_admin = constant('WEB_IS_ADMIN') %}
    {% set web_base = constant('WEB_BASE') %}

    {% set kazi_url = get_context('kazi_url') %}
    {% set item = get_context('item') %}
    {% set table_name = setting.parameters.source.join_table_name|replace({'#__': ''}) %}
    {% set data_source = setting.parameters.source.data_source %}
    {% set join_field = setting.parameters.source.join_field %}
    {% set display_field = setting.parameters.source.display_field|join('|') %}
    {% set path = table_name|split('_') %}
    {% set system_path = table_name|replace({'_': '/'}) ~ '/task' %}

    {% if web_is_admin %}
        {% set system_path = 'admin/' ~ system_path %}
    {% endif %}

    {% set app = path.0 %}
    {% set com = path.1 %}

    {% if path|length == 2 %}
        {% set subset = path.1 %}
    {% else %}
        {% set subset = path.2 %}
    {% endif %}

    {{ forms.input(name~'_autocomplete', 'text', null, label, class, id, attributes~' auto_field="' ~ name|replace({'.':'_'}) ~ '"', readonly, yes_no_options, setting, context) }}
    {{ forms.input(name, 'hidden', default) }}

    <script>

        jQuery(document).ready(function () {

            //Start Initialize
            data_object = {};
            data_object['default_value'] = '{{ default }}';
            data_object['join_field'] = '{{ join_field }}';
            data_object['display_field'] = '{{ display_field }}';
            data_object['_token'] = jQuery('#_token').val();
            var default_value = kazist.callAjax('{{ web_base }}/{{ system_path }}?activity=ajaxautocompletedefault', data_object, true);

            jQuery('input.{{ name|replace({'.':'_'}) }}_autocomplete').val(default_value);
            //End Initialize      

            jQuery('input.{{ name|replace({'.':'_'}) }}_autocomplete').autocomplete({
                minLength: 3,
                messages: {
                    noResults: '',
                    results: function () {
                    }
                },
                focus: function () {
                    // prevent value inserted on focus
                    return true;
                },
                select: function (event, ui) {

                    var field_name = jQuery('input.{{ name|replace({'.':'_'}) }}_autocomplete').attr('auto_field');

console.log(field_name);
                    var terms = kazist_autocomplete.split(this.value);
                    jQuery("#" + field_name).val(ui.item.value);
                    jQuery(this).val(ui.item.label);
                    return false;
                },
                source: function (request, response) {

                    var input_box = jQuery('input.{{ name|replace({'.':'_'}) }}_autocomplete');
                    var input_box_group = jQuery('.{{ name|replace({'.':'_'}) }}_autocomplete-group label');

                    data_object = {};
                    data_object['keyword'] = input_box.val();
                    data_object['field_name'] = '{{ name|replace({'.':'_'}) }}';
                    data_object['join_field'] = '{{ join_field }}';
                    data_object['display_field'] = '{{ display_field }}';
                    data_object['_token'] = jQuery('#_token').val();

                    kazist.addSpinningIcon(input_box_group);
                    jQuery.ajax({
                        type: "POST",
                        url: '{{ web_base }}/{{ system_path }}?activity=ajaxautocomplete',
                        data: data_object,
                        success: response,
                        dataType: 'json',
                        minLength: 3,
                        delay: 100
                    });
                    kazist.removeSpinningIcon(input_box_group);
                }
            });
        });

    </script>

{% endmacro %}

